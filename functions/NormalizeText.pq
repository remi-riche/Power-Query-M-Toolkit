/*
D√©veloppeur : R√©mi RICHE
Version : 2024.04.27.04
Email : r.riche@dataipa.com

Cette fonction Power Query M personnalis√©e, 'NormalizeText', est con√ßue pour normaliser le texte. Elle convertit le texte en minuscules, remplace les caract√®res accentu√©s et sp√©ciaux par leurs √©quivalents non accentu√©s, transforme les lettres stylis√©es en lettres standard, retire les emojis et autres symboles, et standardise les espaces (y compris les tabulations et les espaces multiples). Elle prend une cha√Æne de caract√®res en entr√©e (qui peut √™tre null) et retourne la cha√Æne normalis√©e.
*/

let
    NormalizeText = (inputText as nullable text) as text =>
    let
        // 1. V√©rifier si le texte est null
        CheckedText = if inputText = null then "" else inputText,

        // 2. Convertir le texte en minuscules
        LowercaseText = Text.Lower(CheckedText),

        // 3. Remplacer les caract√®res accentu√©s et sp√©ciaux par des non accentu√©s
        ReplaceAccentsAndSpecialChars = 
            let
                AccentedChars = {
                    "√°","√†","√¢","√§","√£","√•","ƒÅ","ƒÉ","ƒÖ",
                    "√©","√®","√™","√´","ƒì","ƒó","ƒô",
                    "√≠","√¨","√Æ","√Ø","ƒ´","ƒØ","√¨",
                    "√≥","√≤","√¥","√∂","√µ","√∏","≈ç","≈ë","√∞",
                    "√∫","√π","√ª","√º","≈´","≈Ø","≈±","≈≥",
                    "√ß","√±","√ü","≈ì","√¶",
                    "√æ","≈æ","√ø","√Ω","¬µ"
                },
                NonAccentedChars = {
                    "a","a","a","a","a","a","a","a","a",
                    "e","e","e","e","e","e","e",
                    "i","i","i","i","i","i","i",
                    "o","o","o","o","o","o","o","o","o",
                    "u","u","u","u","u","u","u","u",
                    "c","n","ss","oe","ae",
                    "th","z","y","y","u"
                },
                ReplacedText = List.Accumulate(
                    List.Zip({AccentedChars, NonAccentedChars}), 
                    LowercaseText, 
                    (state, replacement) => Text.Replace(state, replacement{0}, replacement{1})
                )
            in
                ReplacedText,

        // 4. Remplacer les lettres stylis√©es par des lettres standard
        ReplaceStylizedLetters =
            let
                StylizedChars = {
                    // Fraktur Letters (minuscule)
                    "ùîû","ùîü","ùî†","ùî°","ùî¢","ùî£","ùî§","ùî•","ùî¶","ùîß","ùî®","ùî©","ùî™","ùî´","ùî¨","ùî≠","ùîÆ","ùîØ","ùî∞","ùî±","ùî≤","ùî≥","ùî¥","ùîµ","ùî∂","ùî∑",
                    // Fraktur Letters (majuscule)
                    "ùîÑ","ùîÖ","ùîá","ùîà","ùîâ","ùîä","ùîç","ùîé","ùîè","ùîê","ùîë","ùîí","ùîì","ùîî","ùîñ","ùîó","ùîò","ùîô","ùîö","ùîõ","ùîú","‚Ñå",
                    // Script Letters (minuscule)
                    "ùì™","ùì´","ùì¨","ùì≠","ùìÆ","ùìØ","ùì∞","ùì±","ùì≤","ùì≥","ùì¥","ùìµ","ùì∂","ùì∑","ùì∏","ùìπ","ùì∫","ùìª","ùìº","ùìΩ","ùìæ","ùìø","ùîÄ","ùîÅ","ùîÇ","ùîÉ",
                    // Script Letters (majuscule)
                    "ùìê","ùìë","ùìí","ùìì","ùìî","ùìï","ùìñ","ùìó","ùìò","ùìô","ùìö","ùìõ","ùìú","ùìù","ùìû","ùìü","ùì†","ùì°","ùì¢","ùì£","ùì§","ùì•","ùì¶","ùìß","ùì®","ùì©",
                    // Bold Letters (minuscule)
                    "ùêö","ùêõ","ùêú","ùêù","ùêû","ùêü","ùê†","ùê°","ùê¢","ùê£","ùê§","ùê•","ùê¶","ùêß","ùê®","ùê©","ùê™","ùê´","ùê¨","ùê≠","ùêÆ","ùêØ","ùê∞","ùê±","ùê≤","ùê≥",
                    // Bold Letters (majuscule)
                    "ùêÄ","ùêÅ","ùêÇ","ùêÉ","ùêÑ","ùêÖ","ùêÜ","ùêá","ùêà","ùêâ","ùêä","ùêã","ùêå","ùêç","ùêé","ùêè","ùêê","ùêë","ùêí","ùêì","ùêî","ùêï","ùêñ","ùêó","ùêò","ùêô",
                    // Italic Letters (minuscule)
                    "ùí∂","ùí∑","ùí∏","ùíπ","ùí∫","ùíª","ùíº","ùíΩ","ùíæ","ùíø","ùìÄ","ùìÅ","ùìÇ","ùìÉ","ùì∏","ùìÖ","ùìÜ","ùìá","ùìà","ùìâ","ùìä","ùìã","ùìå","ùìç","ùìé","ùìè",
                    // Italic Letters (majuscule)
                    "ùíú","ùíù","ùíû","ùíü","ùí†","ùí°","ùí¢","ùí£","ùí•","ùí¶","ùí©","ùí™","ùí´","ùí¨","ùíÆ","ùíØ","ùí∞","ùí±","ùí≤","ùí≥","ùí¥","ùíµ",
                    // Bold Italic Letters (minuscule)
                    "ùí∂","ùí∑","ùí∏","ùíπ","ùí∫","ùíª","ùíº","ùíΩ","ùíæ","ùíø","ùìÄ","ùìÅ","ùìÇ","ùìÉ","ùì∏","ùìÖ","ùìÜ","ùìá","ùìà","ùìâ","ùìä","ùìã","ùìå","ùìç","ùìé","ùìè",
                    // Bold Italic Letters (majuscule)
                    "ùíú","ùíù","ùíû","ùíü","ùí†","ùí°","ùí¢","ùí£","ùí•","ùí¶","ùí©","ùí™","ùí´","ùí¨","ùíÆ","ùíØ","ùí∞","ùí±","ùí≤","ùí≥","ùí¥","ùíµ",
                    // Sans-Serif Letters (minuscule)
                    "ùóÆ","ùóØ","ùó∞","ùó±","ùó≤","ùó≥","ùó¥","ùóµ","ùó∂","ùó∑","ùó∏","ùóπ","ùó∫","ùóª","ùóº","ùóΩ","ùóæ","ùóø","ùòÄ","ùòÅ","ùòÇ","ùòÉ","ùòÑ","ùòÖ","ùòÜ","ùòá",
                    // Sans-Serif Letters (majuscule)
                    "ùóî","ùóï","ùóñ","ùóó","ùóò","ùóô","ùóö","ùóõ","ùóú","ùóù","ùóû","ùóü","ùó†","ùó°","ùó¢","ùó£","ùó§","ùó•","ùó¶","ùóß","ùó®","ùó©","ùó™","ùó´","ùó¨","ùó≠",
                    // Monospace Letters (minuscule)
                    "ùöä","ùöã","ùöå","ùöç","ùöé","ùöè","ùöê","ùöë","ùöí","ùöì","ùöî","ùöï","ùöñ","ùöó","ùöò","ùöô","ùöö","ùöõ","ùöú","ùöù","ùöû","ùöü","ùö†","ùö°","ùö¢","ùö£",
                    // Monospace Letters (majuscule)
                    "ùô∞","ùô±","ùô≤","ùô≥","ùô¥","ùôµ","ùô∂","ùô∑","ùô∏","ùôπ","ùô∫","ùôª","ùôº","ùôΩ","ùôæ","ùôø","ùöÄ","ùöÅ","ùöÇ","ùöÉ","ùöÑ","ùöÖ","ùöÜ","ùöá","ùöà","ùöâ",
                    // Superscript Letters and Numbers
                    "‚Å±","‚Å∞","¬π","¬≤","¬≥","‚Å¥","‚Åµ","‚Å∂","‚Å∑","‚Å∏","‚Åπ","‚Å∫","‚Åª","‚Åº","‚ÅΩ","‚Åæ",
                    // Subscript Letters and Numbers
                    "‚ÇÄ","‚ÇÅ","‚ÇÇ","‚ÇÉ","‚ÇÑ","‚ÇÖ","‚ÇÜ","‚Çá","‚Çà","‚Çâ","‚Çä","‚Çã","‚Çå","‚Çç","‚Çé",
                    // Other Stylized Characters
                    "_","‚Ä¢","‚ô°","‚ù§","‚òÖ","‚òÜ","‚úì","‚úî","‚úï","‚úñ","‚ú¶","‚úß","‚ùÑ","‚ùá","‚ùå","‚ùé","‚úà","‚úâ","‚úÇ","‚òé","‚òÄ","‚òÅ","‚òÇ","‚òÉ","‚òÑ","‚òë","‚òì","‚òû","‚òü","‚ò†","‚ò£","‚ò§","‚ò¶","‚ò™","‚òÆ","‚òØ","‚ò∏","‚ú°","‚úù","‚úû","‚ú†"
                },
                StandardChars = {
                    // Fraktur Letters
                    "a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z",
                    "a","b","d","e","f","g","j","k","l","m","n","o","p","q","s","t","u","v","w","x","y","h",
                    // Script Letters
                    "a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z",
                    "a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z",
                    // Bold Letters
                    "a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z",
                    "A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z",
                    // Italic Letters
                    "a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z",
                    "A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z",
                    // Bold Italic Letters
                    "a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z",
                    "A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z",
                    // Sans-Serif Letters
                    "a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z",
                    "A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z",
                    // Monospace Letters
                    "a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z",
                    "A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z",
                    // Superscript Letters and Numbers
                    "i","0","1","2","3","4","5","6","7","8","9","+","-","=","(",")",
                    // Subscript Letters and Numbers
                    "0","1","2","3","4","5","6","7","8","9","+","-","=","(",")",
                    // Other Stylized Characters
                    " "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "
                },
                // Assurez-vous que les listes ont la m√™me longueur
                // Si ce n'est pas le cas, il faut ajuster les listes
                // Ici, les listes sont con√ßues pour √™tre de la m√™me longueur
                ReplacedStylizedText = List.Accumulate(
                    List.Zip({StylizedChars, StandardChars}), 
                    ReplaceAccentsAndSpecialChars, 
                    (state, replacement) => Text.Replace(state, replacement{0}, replacement{1})
                )
            in
                ReplacedStylizedText,

        // 5. Supprimer les emojis et autres symboles en conservant uniquement les lettres a-z, les chiffres 0-9 et les espaces
        RemoveEmojisAndSymbols = Text.Select(ReplaceStylizedLetters, {"a".."z", "0".."9", " "}), 

        // 6. Remplacer les ponctuations et les caract√®res de contr√¥le par des espaces
        ReplacePunctuationAndControlChars = 
            let
                Punctuations = {".", ",", ";", ":", "!", "?", "(", ")", "[", "]", "{", "}", "<", ">", "/", "\\", "|", "@", "#", "$", "%", "^", "&", "*", "+", "=", "~", "`", "'", "\"", "‚Ä¢", "‚ô°", "‚ù§", "‚òÖ", "‚òÜ", "‚úì", "‚úî", "‚úï", "‚úñ", "‚ú¶", "‚úß", "‚ùÑ", "‚ùá", "‚ùå", "‚ùé", "‚úà", "‚úâ", "‚úÇ", "‚òé", "‚òÄ", "‚òÅ", "‚òÇ", "‚òÉ", "‚òÑ", "‚òë", "‚òì", "‚òû", "‚òü", "‚ò†", "‚ò£", "‚ò§", "‚ò¶", "‚ò™", "‚òÆ", "‚òØ", "‚ò∏", "‚ú°", "‚úù", "‚úû", "‚ú†"},
                ReplaceWithSpace = List.Accumulate(
                    Punctuations, 
                    RemoveEmojisAndSymbols, 
                    (state, punctuation) => Text.Replace(state, punctuation, " ")
                )
            in
                ReplaceWithSpace,

        // 7. Remplacer les tabulations, retours √† la ligne, etc., par des espaces
        ReplaceControlChars = Text.Replace(ReplacePunctuationAndControlChars, "#(cr)", " "),
        ReplaceControlChars2 = Text.Replace(ReplaceControlChars, "#(lf)", " "),
        ReplaceControlChars3 = Text.Replace(ReplaceControlChars2, "#(tab)", " "),

        // 8. Remplacer les multiples espaces par un seul espace
        SimplifiedText = Text.Combine(Text.Split(ReplaceControlChars3, " "), " "),

        // 9. Supprimer les espaces en d√©but et fin de cha√Æne
        TrimmedText = Text.Trim(SimplifiedText)
    in
        TrimmedText
in
    NormalizeText
